#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Built-in echo provider for alert. Outputs to stderr with
# timestamp and caller script name.
# Format: 2026-01-25T14:32:15Z deploy: ALERT: message
set -euo pipefail

if [[ $# -eq 0 ]]; then
  echo "Usage: alert-echo <message>" >&2
  echo "Error: message argument required" >&2
  exit 42
fi

message="$*"
timestamp=$(date -u '+%Y-%m-%dT%H:%M:%SZ')

# Get grandparent process name (caller of our caller)
# Handle PID 0/1 cases (container init) where grandparent lookup fails
grandparent_pid=$(ps -o ppid= -p "${PPID}" 2>/dev/null | tr -d ' ') || true
if [[ -n "${grandparent_pid}" && "${grandparent_pid}" != "0" ]]; then
  script_name=$(ps -o comm= -p "${grandparent_pid}" 2>/dev/null | tr -d ' ') || true
else
  script_name=""
fi
script_name="${script_name:-UNKNOWN_CALLER}"

echo "${timestamp} ${script_name}: ALERT: ${message}" >&2
