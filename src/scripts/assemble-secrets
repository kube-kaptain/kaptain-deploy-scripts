#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Assemble secrets: substitute tokens into template files.
set -euo pipefail

base="${RUN_BASE_PATH:-/run}"
work="${base}/work"
manifests_dir="${work}/manifests"
decrypted_dir="${work}/decrypted"

# Source the token formatting library (borrowed from buildon-github-actions)
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${script_dir}/lib/token-format.bash"

substitute_secret_fields() {
  local template="$1"
  local decrypted="$2"
  local delimiter_style="${TOKEN_DELIMITER_STYLE}"

  local substitute_cmd="${script_dir}/util/substitute-tokens-from-dir"

  local tmp_value
  tmp_value=$(mktemp)
  trap "rm -f '${tmp_value}'" RETURN

  # Iterate each stringData field, substitute tokens in its value, set back via yq
  local key
  while IFS= read -r key; do
    # Extract field value to temp file
    yq ".stringData.\"${key}\"" "${template}" > "${tmp_value}"

    # Run token substitution providers on the extracted value
    "${substitute_cmd}" "${delimiter_style}" "${decrypted}" "${tmp_value}"

    # Read substituted value and set back via yq (multiline-safe)
    local substituted
    substituted=$(<"${tmp_value}")
    substituted="${substituted}" yq -i ".stringData.\"${key}\" = strenv(substituted)" "${template}"
  done < <(yq '.stringData | keys | .[]' "${template}")
}

shopt -s globstar nullglob
templates=("${manifests_dir}"/**/*.template.yaml)
shopt -u globstar nullglob

if [[ ${#templates[@]} -eq 0 ]]; then
  log "No template files found - skipping substitution"
  exit 0
fi

count=0
for template in "${templates[@]}"; do
  substitute_secret_fields "${template}" "${decrypted_dir}"
  output="${template%.template.yaml}.yaml"
  mv "${template}" "${output}"
  count=$((count + 1))
done

log "Processed ${count} template files"
