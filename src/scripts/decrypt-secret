#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Decrypt a single secret file. Takes relative path and suffix.
# Output preserves directory structure in decrypted dir.
#
# Usage: decrypt-secret <relative-path> <suffix>
# Example: decrypt-secret foo/bar.age .age
set -euo pipefail

if [[ $# -ne 2 ]]; then
  echo "Usage: decrypt-secret <relative-path> <suffix>" >&2
  exit 42
fi

relative_path="$1"
suffix="$2"

base="${RUN_BASE_PATH:-/run}"
secrets_dir="${base}/secrets"
decrypted_dir="${base}/work/decrypted"

input_file="${secrets_dir}/${relative_path}"

if [[ ! -f "${input_file}" ]]; then
  echo "ERROR: Input file does not exist: ${input_file}" >&2
  exit 1
fi

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
providers_dir="${script_dir}/plugins/decryption-providers"

provider_script="${providers_dir}/decrypt-${suffix#.}"

if [[ ! -x "${provider_script}" ]]; then
  echo "ERROR: Decrypt provider not found or not executable: ${provider_script}" >&2
  exit 1
fi

# Strip suffix to get output path
output_relative="${relative_path%"${suffix}"}"
output_file="${decrypted_dir}/${output_relative}"

# Ensure output directory exists for nested paths
output_parent=$(dirname "${output_file}")
mkdir -p "${output_parent}"

"${provider_script}" "${input_file}" "${output_file}"
