#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# Decrypt using age identity key file.
# Requires age >= 1.3.1 in the base image.
set -euo pipefail

input_file="$1"
output_file="$2"
mount_base="${MOUNT_BASE_PATH:-}"
identity_file="${mount_base}/secret/environmentPassphrase"

if ! command -v age &> /dev/null; then
  echo "ERROR: age binary not found - install age in base image" >&2
  exit 1
fi

identity=$(<"${identity_file}")

if [[ "${identity}" != AGE-SECRET-KEY-* ]]; then
  echo "ERROR: Secret does not contain a valid age identity key" >&2
  exit 1
fi

age -d -i "${identity_file}" -o "${output_file}" "${input_file}"
