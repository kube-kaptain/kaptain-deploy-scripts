#!/usr/bin/env bash
# SPDX-License-Identifier: MIT
# Copyright (c) 2025-2026 Kaptain contributors (Fred Cooke)
#
# substitute-stringtemplate-style-token - Substitutes $TOKEN$ tokens in a file
#
# Called from tokens directory as working directory.
# Substitutes $TOKEN_NAME$ with TOKEN_VALUE in-place in target file.
#
# Usage:
#   substitute-stringtemplate-style-token <token-file> <target-file>
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_ERROR_PREFIX="${LOG_ERROR_PREFIX:-}"
LOG_ERROR_SUFFIX="${LOG_ERROR_SUFFIX:-}"

if [[ ${#} -ne 2 ]]; then
  echo "${LOG_ERROR_PREFIX}Usage: substitute-stringtemplate-style-token <token-file> <target-file>${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

TOKEN_FILE="${1}"
TARGET="${2}"

if [[ ! -f "${TOKEN_FILE}" ]]; then
  echo "${LOG_ERROR_PREFIX}Token file not found: ${TOKEN_FILE}${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

if [[ ! -f "${TARGET}" ]]; then
  echo "${LOG_ERROR_PREFIX}Target file not found: ${TARGET}${LOG_ERROR_SUFFIX}" >&2
  exit 1
fi

# shellcheck source=src/scripts/lib/prepare-token-name-and-value.bash
# shellcheck disable=SC1091 # shellcheck can't resolve dynamic path
source "${SCRIPT_DIR}/../../lib/prepare-token-name-and-value.bash"

substitute_in_file() {
  local file="${1}"
  local token_name="${2}"
  local value="${3}"
  local count=0

  local content
  content=$(cat "${file}" && echo x)
  content="${content%x}"

  # Pattern: $TOKEN_NAME$
  local pattern="\$${token_name}\$"

  if [[ "${content}" != *"${pattern}"* ]]; then
    echo "${count}"
    return 0
  fi

  local result=""
  local remainder="${content}"

  while [[ "${remainder}" == *"${pattern}"* ]]; do
    # shellcheck disable=SC2295 # token_name is validated (no glob chars)
    local prefix="${remainder%%\$${token_name}\$*}"
    # shellcheck disable=SC2295 # token_name is validated (no glob chars)
    local suffix="${remainder#*\$${token_name}\$}"
    result="${result}${prefix}${value}"
    remainder="${suffix}"
    count=$((count + 1))
  done
  result="${result}${remainder}"

  printf '%s' "${result}" > "${file}"
  echo "${count}"
}

# shellcheck disable=SC2153,SC2154 # TOKEN_NAME/TOKEN_VALUE set by sourced prepare-token-name-and-value.bash
substitute_in_file "${TARGET}" "${TOKEN_NAME}" "${TOKEN_VALUE}"
